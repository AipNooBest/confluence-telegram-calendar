# Календарный бот

## Принцип работы
Программа разделена на две части: постоянно работающий обработчик (телеграм-бот, `telegram.py`) и скрипт, запускающийся по расписанию (`main.py`). Каждый день в 18:30 по МСК (настраивается в Dockerfile, время в GMT+0) всем сотрудникам отправляется уведомление с просьбой отметиться сколько времени они сегодня проработали.
- Сотрудник, запись о котором отсутствует в БД, не может пользоваться ботом.
- Все данные сохраняются в MongoDB и синхронизируются со страницей календаря в Confluence.
- При конфликте данных приоритет отдаётся странице календаря. 
- Праздничные (выходные) дни, не указанные в календаре, учитываются автоматически, но иногда продолжительные праздники не учитываются (например, 8 мая может считаться рабочим, а 9 выходным), поэтому данные дни лучше указывать вручную.
- В дни, указанные в календаре как выходные, уведомления не приходят.
- Если сотрудник отработал в выходной, ему необходимо отметиться либо через команду `/notify` в боте, либо вручную в календаре.
- Указание часов вручную на странице календаря может быть в любых тегах, бот сможет их распознать, но **крайне желательно**, чтобы это был тэг `sub` в формате `<sub>6ч</sub>` (нижний индекс)
- Смена месяцев происходит автоматически в первый день нового месяца прямо перед отправкой уведомлений. Если этого не произошло, см. [ручные правки](#ручные-правки)

## Добавление сотрудника
В первую очередь необходимо получить ID сотрудника в Telegram. Делается это с помощью команды `/id` с аккаунта, который требуется добавить. Далее необходимо подключиться к MongoDB либо через Compass, либо любым другим удобным способом, и добавить запись о сотруднике в коллекцию `telegrams` в таком виде:
```json
{
    "full_name": "Фамилия Имя Отчество",
    "user_id": 123456789
}
```
После этого необходимо добавить на страницу календаря макрос "Раскрыть" с заголовком "Фамилия Имя Отчество" (обязательно должно совпадать со значением full_name в БД) и с тремя таблицами-месяцами. С этого момента сотрудник может пользоваться ботом.

## Установка
После клонирования репозитория необходимо настроить конфиг. Пример находится в файле `config.example.py`. Перед первым запуском надо скопировать пример и настроить сам конфиг:
```bash
cp config.example.py config.py
nano config.py
# И теперь можно запускать бота
docker-compose up -d
```
У каждого модуля (`main.py` и `telegram.py`) имеются свои логи на уровне INFO, они записываются в соответствующие файлы.

## Ручные правки
Если какая-то часть бота не сработала автоматически, необходимо что-то сделать вручную или использовать что-то отдельно, можно вызвать методы напрямую из нужного модуля.

#### Обновление месяца
```bash
sudo docker exec calendar-bot python -c 'import calendar_handler as ch; ch.update_month()'
```

#### Отправка массового уведомления
```bash
sudo docker exec calendar-bot python main.py
```

#### Отправка уведомления одному человеку
```bash
sudo docker exec calendar-bot python -c 'import telegram; telegram.send_notification(123456789)'
```
